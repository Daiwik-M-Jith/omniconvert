(()=>{const $=id=>document.getElementById(id);const form=$('convert-form'),fileInput=$('file-input'),target=$('target-format'),hist=$('history-list'),msg=$('message');async function fm(){try{return(await fetch('/api/formats')).json()}catch{return[]}}async function getHistory(){try{return(await fetch('/api/history')).json()}catch{return[]}}async function renderTargets(){target.innerHTML='';const f=fileInput.files[0];if(!f){const o=document.createElement('option');o.value='';o.textContent='Pick a file first';target.appendChild(o);return}const ext=f.name.split('.').pop().toLowerCase();const fmts=await fm();const e=fmts.find(x=>x.source===ext);if(!e){target.innerHTML='<option value="">No targets</option>';return}e.targets.forEach(t=>{const o=document.createElement('option');o.value=t.ext;o.textContent=t.ext.toUpperCase();target.appendChild(o)})}async function refreshHistory(){const data=await getHistory();hist.innerHTML='';data.forEach(j=>{const li=document.createElement('li');li.className='history-item';const txt=document.createElement('div');txt.textContent=`#${j.id} ${j.source_name} → ${j.target_format.toUpperCase()}`;const actions=document.createElement('div');if(j.artifact_stored){const d=document.createElement('button');d.className='small';d.textContent='Download';d.onclick=()=>dl(j.id);actions.appendChild(d);}if(j.original_stored){const r=document.createElement('button');r.className='small';r.textContent='Re-run';r.onclick=async()=>{await fetch(`/api/jobs/${j.id}/reconvert`,{method:'POST'});await refreshHistory()};actions.appendChild(r)}{const s=document.createElement('button');s.className='small';s.textContent='Share';s.onclick=async()=>{const res=await fetch(`/api/jobs/${j.id}/share`,{method:'POST'});if(res.ok){const jn=await res.json();try{await navigator.clipboard.writeText(jn.share_url);alert('Share URL copied: '+jn.share_url)}catch{alert(jn.share_url)}}else{alert('Share failed')}};actions.appendChild(s)}li.appendChild(txt);li.appendChild(actions);hist.appendChild(li)})}async function dl(id){try{const res=await fetch(`/api/jobs/${id}/artifact`);if(!res.ok)throw new Error('not');const blob=await res.blob();const cd=res.headers.get('Content-Disposition')||'';const fn=cd.split('filename=')[1]||`artifact-${id}`;const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn.replace(/"/g,'');document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),2000)}catch(e){msg.textContent=e.message}}form.addEventListener('submit',async(e)=>{e.preventDefault();if(!fileInput.files[0]){msg.textContent='Pick a file';return}if(!target.value){msg.textContent='Pick a target';return}const fd=new FormData();fd.append('file',fileInput.files[0]);fd.append('target_format',target.value);msg.textContent='Converting...';try{const r=await fetch('/api/convert',{method:'POST',body:fd});if(!r.ok){const err=await r.json().catch(()=>({detail:'Conversion failed'}));throw new Error(err.detail||'Conversion failed')}const blob=await r.blob();const cd=r.headers.get('Content-Disposition')||'';const fn=cd.split('filename=')[1]||'converted';const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn.replace(/"/g,'');document.body.appendChild(a);a.click();a.remove();msg.textContent='Done';fileInput.value='';await refreshHistory()}catch(err){msg.textContent=err.message||'Conversion failed'}});fileInput.addEventListener('change',()=>{renderTargets()});window.addEventListener('load',async()=>{await renderTargets();await refreshHistory()});})();
// Minimal frontend for OmniConvert (app.min.js)
(()=>{function $(id){return document.getElementById(id);}const form=$('convert-form'),fileInput=$('file-input'),target=$('target-format'),hist=$('history-list'),msg=$('message');async function fmt(){try{const r=await fetch('/api/formats');return await r.json()}catch{return[]}}async function rh(){try{const r=await fetch('/api/history');const d=await r.json();hist.innerHTML='';d.forEach(j=>{const li=document.createElement('li');li.className='history-item';const t=document.createElement('div');t.textContent=`#${j.id} ${j.source_name} → ${j.target_format.toUpperCase()}`;const a=document.createElement('div');if(j.artifact_stored){const b=document.createElement('button');b.className='small';b.textContent='Download';b.onclick=()=>dl(j.id);a.appendChild(b);}li.appendChild(t);li.appendChild(a);hist.appendChild(li)});}catch(e){console.warn(e)}}async function dl(id){try{const r=await fetch(`/api/jobs/${id}/artifact`);if(!r.ok)throw new Error('not');const blob=await r.blob();const cd=r.headers.get('Content-Disposition')||'';const fn=cd.split('filename=')[1]||`artifact-${id}`;const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn.replace(/"/g,'');document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),3000);}catch(e){msg.textContent=e.message}}async function renderTargets(){target.innerHTML='';const f=fileInput.files[0];if(!f){const o=document.createElement('option');o.value='';o.textContent='Pick a file first';target.appendChild(o);return}const ext=f.name.split('.').pop().toLowerCase();const fmts=await fmt();const entry=fmts.find(e=>e.source===ext);if(!entry){target.innerHTML='<option value="">No targets</option>';return}entry.targets.forEach(t=>{const o=document.createElement('option');o.value=t.ext;o.textContent=t.ext.toUpperCase();target.appendChild(o)})}form.addEventListener('submit',async e=>{e.preventDefault();if(!fileInput.files[0]){msg.textContent='Pick a file';return}if(!target.value){msg.textContent='Pick a target';return}const fd=new FormData();fd.append('file',fileInput.files[0]);fd.append('target_format',target.value);msg.textContent='Converting...';try{const r=await fetch('/api/convert',{method:'POST',body:fd});if(!r.ok){const j=await r.json().catch(()=>({detail:'Conversion failed'}));throw new Error(j.detail||'Conversion failed')}const blob=await r.blob();const cd=r.headers.get('Content-Disposition')||'';const fname=cd.split('filename=')[1]||'converted';const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fname.replace(/"/g,'');document.body.appendChild(a);a.click();a.remove();msg.textContent='Done';fileInput.value='';await rh();}catch(err){msg.textContent=err.message||'Conversion failed'}});fileInput.addEventListener('change',renderTargets);window.addEventListener('load',async()=>{await renderTargets();await rh();});})();
